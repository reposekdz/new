
import { GeneratedFile, AIModel, Attachment, ChatMessage, GenerationType, Platform, ProgrammingLanguage } from "../types";

const API_BASE = 'http://localhost:3001/api';

export const generateAppCode = async (
  userPrompt: string, 
  model: AIModel, 
  attachments: Attachment[] = [],
  currentFiles: GeneratedFile[] = [],
  history: ChatMessage[] = [],
  platform: Platform = 'web',
  language: ProgrammingLanguage = 'typescript'
): Promise<GeneratedFile[]> => {
  try {
    const response = await fetch(`${API_BASE}/generate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: userPrompt,
        model,
        attachments,
        currentFiles,
        history,
        platform,
        language
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Generation failed');
    }

    return await response.json();
  } catch (error: any) {
    console.error("API Error:", error);
    throw new Error(error.message || "Failed to connect to OmniGen backend");
  }
};

export const runCodeSimulation = async (files: GeneratedFile[], command: string): Promise<string> => {
  try {
    const response = await fetch(`${API_BASE}/execute`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ files, command })
    });

    if (!response.ok) throw new Error("Execution failed");
    return await response.text();
  } catch (error: any) {
    return `[CONNECTION ERROR]: ${error.message}. Ensure backend is running on port 3001.`;
  }
};

export const importGithubRepo = async (repoUrl: string): Promise<GeneratedFile[]> => {
    try {
        const response = await fetch(`${API_BASE}/import/github`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ repoUrl })
        });
        
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || "Failed to import GitHub repository");
        }
        return await response.json();
    } catch (error: any) {
        console.error("GitHub Import Error:", error);
        throw new Error(error.message || "Failed to import GitHub repository");
    }
};

/**
 * Generates initial project scaffolding based on platform and language
 */
export const setupProject = (projectName: string = 'omnigen-app', language: ProgrammingLanguage = 'typescript'): GeneratedFile[] => {
  const files: GeneratedFile[] = [];

  // Basic .gitignore
  files.push({
    path: '.gitignore',
    content: `node_modules\n.DS_Store\ndist\nbuild\n.env\n.vscode/\n__pycache__/\nvenv/\ntarget/`
  });

  // README.md
  files.push({
    path: 'README.md',
    content: `# ${projectName}\n\nGenerated by OmniGen AI.\n\n## Language\n${language}`
  });

  return files;
};

/**
 * Returns pre-defined file structures for specific project templates.
 * This allows for instant project creation without waiting for AI generation.
 */
export const getTemplateBoilerplate = (templateId: string): GeneratedFile[] => {
  const basicFiles = setupProject('omnigen-app', 'typescript');

  switch (templateId) {
    case 'react-vite':
      return [
        ...basicFiles,
        {
          path: 'package.json',
          content: JSON.stringify({
            name: "react-vite-app",
            version: "1.0.0",
            dependencies: { "react": "^18.2.0", "react-dom": "^18.2.0", "lucide-react": "^0.300.0" },
            scripts: { "dev": "vite", "build": "vite build", "preview": "vite preview" }
          }, null, 2)
        },
        {
          path: 'index.html',
          content: `<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React App</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>`
        },
        {
          path: 'src/main.jsx',
          content: `import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)`
        },
        {
          path: 'src/App.jsx',
          content: `import React, { useState } from 'react'
import { Sparkles } from 'lucide-react'

function App() {
  const [count, setCount] = useState(0)

  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-100 flex flex-col items-center justify-center p-4 font-sans">
      <div className="flex items-center gap-3 mb-8">
        <Sparkles className="text-indigo-500" size={32} />
        <h1 className="text-4xl font-bold">Vite + React</h1>
      </div>
      <div className="bg-zinc-900 p-8 rounded-xl border border-zinc-800 shadow-xl text-center max-w-md w-full">
        <button 
          onClick={() => setCount((count) => count + 1)}
          className="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-lg font-semibold transition-all w-full mb-4"
        >
          count is {count}
        </button>
        <p className="text-zinc-500">
          Edit <code>src/App.jsx</code> and save to test HMR
        </p>
      </div>
    </div>
  )
}

export default App`
        },
        { path: 'src/index.css', content: `@tailwind base;\n@tailwind components;\n@tailwind utilities;` }
      ];

    case 'saas-dashboard':
      return [
        ...basicFiles,
        {
          path: 'package.json',
          content: JSON.stringify({
            name: "saas-dashboard",
            version: "1.0.0",
            dependencies: { "react": "^18.2.0", "react-dom": "^18.2.0", "lucide-react": "^0.300.0", "recharts": "^2.12.0" },
            scripts: { "dev": "vite", "build": "vite build" }
          }, null, 2)
        },
        { path: 'index.html', content: `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Dashboard</title><script src="https://cdn.tailwindcss.com"></script></head><body><div id="root"></div><script type="module" src="/src/main.tsx"></script></body></html>` },
        { path: 'src/main.tsx', content: `import React from 'react'; import ReactDOM from 'react-dom/client'; import App from './App'; import './index.css'; ReactDOM.createRoot(document.getElementById('root')!).render(<React.StrictMode><App /></React.StrictMode>);` },
        { path: 'src/index.css', content: `@tailwind base;\n@tailwind components;\n@tailwind utilities;` },
        {
          path: 'src/App.tsx',
          content: `import React from 'react';
import { LayoutDashboard, Users, Settings, LogOut, Bell } from 'lucide-react';

const Sidebar = () => (
  <div className="w-64 bg-zinc-900 border-r border-zinc-800 flex flex-col h-screen">
    <div className="p-6 border-b border-zinc-800 font-bold text-indigo-500 text-xl flex items-center gap-2">
       <LayoutDashboard /> OmniDash
    </div>
    <div className="flex-1 p-4 space-y-2">
       <div className="px-4 py-2 bg-indigo-600/10 text-indigo-400 rounded-lg font-medium flex items-center gap-3 cursor-pointer"><LayoutDashboard size={18}/> Dashboard</div>
       <div className="px-4 py-2 text-zinc-400 hover:bg-zinc-800 rounded-lg font-medium flex items-center gap-3 cursor-pointer"><Users size={18}/> Customers</div>
       <div className="px-4 py-2 text-zinc-400 hover:bg-zinc-800 rounded-lg font-medium flex items-center gap-3 cursor-pointer"><Settings size={18}/> Settings</div>
    </div>
    <div className="p-4 border-t border-zinc-800">
       <div className="px-4 py-2 text-red-400 hover:bg-red-900/10 rounded-lg font-medium flex items-center gap-3 cursor-pointer"><LogOut size={18}/> Logout</div>
    </div>
  </div>
);

const Card = ({ title, value, trend }: any) => (
  <div className="bg-zinc-900 p-6 rounded-xl border border-zinc-800">
     <div className="text-zinc-500 text-sm font-medium mb-1">{title}</div>
     <div className="text-3xl font-bold text-white mb-2">{value}</div>
     <div className="text-emerald-400 text-xs font-medium">{trend}</div>
  </div>
);

export default function App() {
  return (
    <div className="flex h-screen bg-black text-white">
      <Sidebar />
      <div className="flex-1 flex flex-col overflow-hidden">
         <header className="h-16 border-b border-zinc-800 flex items-center justify-between px-8">
             <h2 className="font-semibold">Overview</h2>
             <div className="p-2 bg-zinc-900 rounded-full border border-zinc-800"><Bell size={18} /></div>
         </header>
         <main className="flex-1 overflow-y-auto p-8">
             <div className="grid grid-cols-3 gap-6 mb-8">
                <Card title="Total Revenue" value="$45,231.89" trend="+20.1% from last month" />
                <Card title="Active Users" value="+2350" trend="+180.1% from last month" />
                <Card title="Sales" value="+12,234" trend="+19% from last month" />
             </div>
             <div className="bg-zinc-900 rounded-xl border border-zinc-800 h-96 flex items-center justify-center text-zinc-500">
                 [Chart Area Placeholder - Ask AI to add Recharts]
             </div>
         </main>
      </div>
    </div>
  );
}`
        }
      ];

    case '3d-game':
      return [
         ...basicFiles,
         {
            path: 'package.json',
            content: JSON.stringify({
              name: "r3f-game",
              dependencies: { "react": "^18.2.0", "react-dom": "^18.2.0", "three": "^0.160.0", "@react-three/fiber": "^8.15.0", "@react-three/drei": "^9.99.0" },
              scripts: { "dev": "vite", "build": "vite build" }
            }, null, 2)
         },
         { path: 'index.html', content: `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" /><title>3D Game</title><style>body, html, #root { width: 100%; height: 100%; margin: 0; overflow: hidden; background: #000; }</style></head><body><div id="root"></div><script type="module" src="/src/main.jsx"></script></body></html>` },
         {
            path: 'src/main.jsx',
            content: `import { createRoot } from 'react-dom/client'
import { Canvas, useFrame } from '@react-three/fiber'
import { useRef, useState } from 'react'

function Box(props) {
  const meshRef = useRef()
  const [hovered, setHover] = useState(false)
  const [active, setActive] = useState(false)
  
  useFrame((state, delta) => (meshRef.current.rotation.x += delta))
  
  return (
    <mesh
      {...props}
      ref={meshRef}
      scale={active ? 1.5 : 1}
      onClick={() => setActive(!active)}
      onPointerOver={() => setHover(true)}
      onPointerOut={() => setHover(false)}>
      <boxGeometry args={[1, 1, 1]} />
      <meshStandardMaterial color={hovered ? 'hotpink' : 'orange'} />
    </mesh>
  )
}

createRoot(document.getElementById('root')).render(
  <Canvas>
    <ambientLight intensity={Math.PI / 2} />
    <spotLight position={[10, 10, 10]} angle={0.15} penumbra={1} decay={0} intensity={Math.PI} />
    <pointLight position={[-10, -10, -10]} decay={0} intensity={Math.PI} />
    <Box position={[-1.2, 0, 0]} />
    <Box position={[1.2, 0, 0]} />
  </Canvas>,
)`
         }
      ];

    case 'node-express':
      return [
        ...setupProject('express-api', 'typescript'),
        {
          path: 'package.json',
          content: JSON.stringify({
            name: "express-api",
            version: "1.0.0",
            main: "dist/index.js",
            scripts: { "start": "node dist/index.js", "dev": "ts-node src/index.ts" },
            dependencies: { "express": "^4.18.2", "cors": "^2.8.5", "dotenv": "^16.4.0" },
            devDependencies: { "@types/express": "^4.17.21", "typescript": "^5.3.0" }
          }, null, 2)
        },
        {
          path: 'src/index.ts',
          content: `import express from 'express';
import cors from 'cors';

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

app.get('/', (req, res) => {
  res.json({ message: 'Welcome to the OmniGen Express API', timestamp: new Date() });
});

app.get('/health', (req, res) => {
  res.status(200).json({ status: 'ok' });
});

app.listen(PORT, () => {
  console.log(\`Server running on http://localhost:\${PORT}\`);
});`
        }
      ];
    
    default:
      return basicFiles;
  }
};
